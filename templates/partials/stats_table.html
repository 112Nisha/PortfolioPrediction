{%- macro render_stats_table(stats) -%}
    <p><strong>Expected/Average Annual Return (%):</strong> {{ stats.return }}</p>

    <script>
        function toggleInfo(id) {
            var infoElement = document.getElementById('info-' + id);
            if (infoElement.style.display === 'none' || infoElement.style.display === '') {
                infoElement.style.display = 'block';
            } else {
                infoElement.style.display = 'none';
            }
        }
    </script>

    {%- for table in stats.tables %}
        {% if table %}
            {# Get column headers dynamically from first row #}
            {% set first_item = table.values() | list | first %}
            {% set columns = first_item.keys() | list %}
            {% set last_column_name = columns[-1] %}
            
            <table class="table table-bordered mb-4">
                <thead>
                    <tr>
                        <th>Portfolio</th>
                        {# Loop through columns, excluding the last one #}
                        {%- for col in columns[:-1] %}
                            <th>{{ col }}</th>
                        {%- endfor %}
                    </tr>
                </thead>
                <tbody>
                    {%- for portfolio_name, values in table.items() %}
                        {% set unique_id = loop.index %}
                        <tr>
                            <td>
                                {{ portfolio_name }}
                                <button style="border-radius: 50%; width: 20px; height: 20px; text-align: center; padding: 0; font-size: 0.8em; margin-left: 5px;" onclick="toggleInfo('{{ loop.index }}')">i</button>
                                <div id="info-{{ loop.index }}" style="display: none; margin-top: 10px; padding: 5px; border: 1px solid #ddd;">
                                    <strong>{{ last_column_name }}:</strong><br>
                                    {{ values[last_column_name] | safe }}
                                </div>
                            </td>
                            {# Loop through column values, excluding the last one #}
                            {%- for col in columns[:-1] %}
                                <td>
                                    {% if col == "Weights" %}
                                        <pre style="margin: 0; font-size: 0.85em;">{{ values[col] }}</pre>
                                    {% else %}
                                        {{ values[col] | default("N/A") | safe }}
                                    {% endif %}
                                </td>
                            {%- endfor %}
                        </tr>
                    {%- endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">No data available for Table {{ loop.index }}</p>
        {% endif %}
    {%- endfor %}
{%- endmacro %}


<ul class="nav nav-tabs" id="statsTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="train-tab" data-bs-toggle="tab" data-bs-target="#train-tab-pane"
            type="button" role="tab" aria-controls="train-tab-pane" aria-selected="true">
            Training Set
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test-tab-pane" type="button"
            role="tab" aria-controls="test-tab-pane" aria-selected="false">
            Test Set
        </button>
    </li>
</ul>

<div class="tab-content" id="statsTabContent">
    <div class="tab-pane fade show active" id="train-tab-pane" role="tabpanel" aria-labelledby="train-tab" tabindex="0">
        <div class="p-3">
            {{ render_stats_table(stats.train) }}
        </div>
    </div>
    <div class="tab-pane fade" id="test-tab-pane" role="tabpanel" aria-labelledby="test-tab" tabindex="0">
        <div class="p-3">
            {{ render_stats_table(stats.test) }}
        </div>
    </div>
</div>

<!-- <h3 class="mt-4">Optimal Portfolios</h3>
{% for label, weights in stats.weights.items() %}
    <p>{{ label }}</p>
    <pre><code>{{ weights }}</code></pre>
{% endfor %} -->
