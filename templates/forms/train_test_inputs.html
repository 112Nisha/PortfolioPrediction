<div class="d-flex justify-content-start align-items-center gap-3 mt-3">
    <label class="ms-2">Train months:
        <input class="train-months" type="number" name="train_months" value="{{ train_months | default(36) }}" min="1"
            class="form-control d-inline-block" style="width:100px;">
    </label>
    <label class="ms-2">Test months:
        <input class="test-months" type="number" name="test_months" value="{{ test_months | default(3) }}" min="1"
            class="form-control d-inline-block" style="width:100px;">
    </label>
    <div class="ms-3 align-self-center">
        {% if total_months is defined and total_months %}
        <small class="text-muted">Available months: <strong class="total-months">{{ total_months }}</strong></small>
        {% else %}
        <small class="text-muted">Available months: <strong class="total-months">Unknown</strong></small>
        {% endif %}
    </div>

    <label class="ms-2">Risk-free %:
        <input type="number" name="risk_free" value="{{ risk_free | default(7, true) }}" min="0" max="100" step="any"
            class="risk-free-rate form-control d-inline-block" style="width:100px;">
    </label>

    <label class="ms-2">Return estimation:
        <select class="mean-method form-control d-inline-block" name="mean_method" style="width:250px;">
            <option value="mean_historical" {% if mean_method=='mean_historical' %}selected{% endif %}>
                Mean historical return
            </option>
            <option value="ewm_mean_historical" {% if mean_method=='ewm_mean_historical' %}selected{% endif %}>
                Exponentially weighted mean historical return
            </option>
            <option value="capm" {% if mean_method=='capm' %}selected{% endif %}>
                CAPM estimate of returns
            </option>
        </select>
    </label>

    <label class="ms-2">Covariance estimation:
        <select class="cov-method form-control d-inline-block" name="cov_method" style="width:300px;">
            <option value="sample" {% if cov_method=='sample' %}selected{% endif %}>
                Sample covariance
            </option>
            <option value="semicovariance" {% if cov_method=='semicovariance' %}selected{% endif %}>
                Semicovariance
            </option>
            <option value="fix_psd" {% if cov_method=='fix_psd' %}selected{% endif %}>
                Fix non-positive semidefinite matrices
            </option>
            <option value="ewm" {% if cov_method=='ewm' %}selected{% endif %}>
                Exponentially weighted covariance
            </option>
            <option value="mcd" {% if cov_method=='mcd' %}selected{% endif %}>
                Minimum covariance determinant
            </option>
            <optgroup label="Shrunk covariance matrices">
                <option value="manual_shrinkage" {% if cov_method=='manual_shrinkage' %}selected{% endif %}>
                    Manual shrinkage
                </option>
                <option value="ledoit_wolf" {% if cov_method=='ledoit_wolf' %}selected{% endif %}>
                    Ledoit-Wolf shrinkage
                </option>
                <option value="oracle_approx" {% if cov_method=='oracle_approx' %}selected{% endif %}>
                    Oracle-Approximating shrinkage
                </option>
            </optgroup>
            <option value="cov_to_corr" {% if cov_method=='cov_to_corr' %}selected{% endif %}>
                Covariance to correlation matrix
            </option>
        </select>
    </label>

    <div class="ewm-span-container ms-2" style="display:none; min-width: 200px;">
        <label for="ewm-span-slider" class="form-label">EWM Span: <span class="ewm-span-value">{{ ewm_span | default(30)
                }}</span></label>
        <input type="range" class="form-range ewm-span-slider" name="ewm_span" min="1" max="120"
            value="{{ ewm_span | default(30) }}">
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const meanMethodSelects = document.querySelectorAll('.mean-method');
        const covMethodSelects = document.querySelectorAll('.cov-method');
        const ewmSpanContainers = document.querySelectorAll('.ewm-span-container');
        const ewmSpanSliders = document.querySelectorAll('.ewm-span-slider');
        const ewmSpanValues = document.querySelectorAll('.ewm-span-value');

        function toggleEwmSpanVisibilityForForm(index) {
            const meanMethodSelect = meanMethodSelects[index];
            const covMethodSelect = covMethodSelects[index];
            const ewmSpanContainer = ewmSpanContainers[index];

            if (!meanMethodSelect || !covMethodSelect || !ewmSpanContainer) {
                return;
            }

            const isEwmMean = meanMethodSelect.value === 'ewm_mean_historical';
            const isEwmCov = covMethodSelect.value === 'ewm';

            if (isEwmMean || isEwmCov) {
                ewmSpanContainer.style.display = 'block';
            } else {
                ewmSpanContainer.style.display = 'none';
            }
        }

        // Attach event listeners to all instances of mean method selects
        meanMethodSelects.forEach((select, index) => {
            select.addEventListener('change', () => toggleEwmSpanVisibilityForForm(index));
        });

        // Attach event listeners to all instances of covariance method selects
        covMethodSelects.forEach((select, index) => {
            select.addEventListener('change', () => toggleEwmSpanVisibilityForForm(index));
        });

        // Attach input event listeners for the sliders to update the displayed value
        ewmSpanSliders.forEach((slider, index) => {
            slider.addEventListener('input', function () {
                ewmSpanValues[index].textContent = this.value;
            });
        });

        // Initial check for all instances on page load
        for (let i = 0; i < ewmSpanContainers.length; i++) {
            toggleEwmSpanVisibilityForForm(i);
        }
    });
</script>