{% extends 'base.html' %} {% block title %}Home - PortfolioPrediction{% endblock
%} {% block content %}
<style>
    /*select[name="stock"] {
        color: gray; /* Grays out the selected placeholder */
    }*/

    select[name="stock"] option:disabled {
        color: gray; /* Grays out the placeholder when disabled */
    }
</style>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div class="container my-4">
    <h1 class="mb-4 text-primary">Portfolio Mean-Variance Frontier</h1>

    <form method="POST" class="p-4 bg-white rounded shadow-sm mb-4">
        <div id="stocks-container">
            {% if stocks and weights %} {% for i in range(stocks|length) %}
            <div class="stock-input-group mb-3">
                <label for="stock{{ i }}" class="form-label visually-hidden"
                    >Stock {{ i+1 }}:</label
                >
                <!--<input
                    type="text"
                    name="stock"
                    id="stock{{ i }}"
                    placeholder="Stock Symbol (e.g., CIPLA)"
                    class="form-control"
                    value="{{ stocks[i] }}"
                />-->
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)">
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}" {% if s == stocks[i] %} selected {% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>

                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                    value="{{ weights[i] }}"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            {% endfor %} {% else %}
            <div class="stock-input-group mb-3">
                <label for="stock0" class="form-label visually-hidden"
                    >Stock 1:</label
                >
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            <div class="stock-input-group mb-3">
                <label for="stock1" class="form-label visually-hidden"
                    >Stock 2:</label
                >
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            {% endif %}
        </div>
        <div class="d-flex justify-content-start align-items-center gap-3 mt-3">
            <button type="button" id="add-stock-btn" class="btn btn-secondary">
                Add Stock
            </button>
            <button type="submit" class="btn btn-primary">
                Calculate Frontier
            </button>
        </div>
    </form>

    {% if error %}
    <h4 class="mb-3 text-danger">Error: {{ error }}</h4>
    {% endif %} {% if stats %}
    <h2 class="mb-3 text-primary">Portfolio Stats</h2>

    <p><strong>Expected Return (%):</strong> {{ stats.return }}</p>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Risk Measure</th>
                <th>User Portfolio</th>
                <th>Optimised Portfolio</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Variance</td>
                <td>{{ stats.user_variance }}</td>
                <td>
                    {{ stats.opt_variance | default("Could not optimise", true)
                    }}
                </td>
            </tr>
            <tr>
                <td>VaR</td>
                <td>{{ stats.user_var }}</td>
                <td>
                    {{ stats.opt_var | default("Could not optimise", true) }}
                </td>
            </tr>
            <tr>
                <td>CVaR</td>
                <td>{{ stats.user_cvar }}</td>
                <td>
                    {{ stats.opt_cvar | default("Could not optimise", true) }}
                </td>
            </tr>
        </tbody>
    </table>

    <h3 class="mt-4">Optimal Portfolios</h3>

    <p>Variance-Optimised Weights</p>
    <pre><code>{{ stats.opt_variance_weights }}</code></pre>

    <p>VaR-Optimised Weights</p>
    <pre><code>{{ stats.opt_var_weights }}</code></pre>

    <p>CVaR-Optimised Weights</p>
    <pre><code>{{ stats.opt_cvar_weights }}</code></pre>

    <h2 class="mb-3 text-primary">Risk Frontiers</h2>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="variance-tab"
                data-bs-toggle="tab"
                data-bs-target="#variance"
                type="button"
                role="tab"
                aria-controls="variance"
                aria-selected="true"
            >
                Variance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="var-tab"
                data-bs-toggle="tab"
                data-bs-target="#var"
                type="button"
                role="tab"
                aria-controls="var"
                aria-selected="false"
            >
                VaR
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="cvar-tab"
                data-bs-toggle="tab"
                data-bs-target="#cvar"
                type="button"
                role="tab"
                aria-controls="cvar"
                aria-selected="false"
            >
                CVaR
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="backtest-tab"
                data-bs-toggle="tab"
                data-bs-target="#backtest"
                type="button"
                role="tab"
                aria-controls="backtest"
                aria-selected="false"
            >
                Backtest (3M)
            </button>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div
            class="tab-pane fade show active"
            id="variance"
            role="tabpanel"
            aria-labelledby="variance-tab"
        >
            {% if graph_htmls and graph_htmls[0] %} {{ graph_htmls[0]|safe }} {%
            else %}
            <p>No graph 1 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="var"
            role="tabpanel"
            aria-labelledby="var-tab"
        >
            {% if graph_htmls and graph_htmls[1] %} {{ graph_htmls[1]|safe }} {%
            else %}
            <p>No graph 2 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="cvar"
            role="tabpanel"
            aria-labelledby="cvar-tab"
        >
            {% if graph_htmls and graph_htmls[2] %} {{ graph_htmls[2]|safe }} {%
            else %}
            <p>No graph 3 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="backtest"
            role="tabpanel"
            aria-labelledby="backtest-tab"
        >
            {% if backtest_html %} {{ backtest_html|safe }} {% else %}
            <p>
                No backtest available for the selected inputs or insufficient
                history.
            </p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize stockCount from existing DOM inputs (fallback to 2)
        let stockCount =
            document.querySelectorAll(".stock-input-group").length || 2;

        document
            .getElementById("add-stock-btn")
            .addEventListener("click", function () {
                const stocksContainer =
                    document.getElementById("stocks-container");
                const newStockGroup = document.createElement("div");
                newStockGroup.classList.add("stock-input-group", "mb-3");
                newStockGroup.innerHTML = `
                <label for="stock${stockCount}" class="form-label visually-hidden">Stock ${stockCount + 1}:</label>
                <select name="stock" id="stock${stockCount}" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="weight" placeholder="Amount (%)" step="0.01" min="0" class="form-control">
                <button type="button" class="btn btn-danger remove-stock-btn">Remove</button>
            `;
                stocksContainer.appendChild(newStockGroup);
                stockCount++;
            });

        // Event delegation for remove buttons
        document
            .getElementById("stocks-container")
            .addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-stock-btn")) {
                    // Ensure at least two stock inputs remain
                    if (
                        document.querySelectorAll(".stock-input-group").length >
                        2
                    ) {
                        event.target.closest(".stock-input-group").remove();
                    } else {
                        alert(
                            "You must have at least two stocks in your portfolio.",
                        );
                    }
                }
            });
    });
</script>

{% endblock %}
