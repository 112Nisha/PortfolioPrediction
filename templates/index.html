{% extends 'base.html' %} {% block title %}Home - PortfolioPrediction{% endblock
%} {% block content %}
<style>
    /* Optional: make stock select placeholder gray */
    /* select[name="stock"] { color: gray; } */

    select[name="stock"] option:disabled {
        color: gray; /* Grays out the placeholder when disabled */
    }
</style>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div class="container my-4">
    <h1 class="mb-4 text-primary">Portfolio Mean-Variance Frontier</h1>

    <form method="POST" class="p-4 bg-white rounded shadow-sm mb-4">
        <div id="stocks-container">
            {% if stocks and weights %} {% for i in range(stocks|length) %}
            <div class="stock-input-group mb-3">
                <label for="stock{{ i }}" class="form-label visually-hidden"
                    >Stock {{ i+1 }}:</label
                >
                <!--<input
                    type="text"
                    name="stock"
                    id="stock{{ i }}"
                    placeholder="Stock Symbol (e.g., CIPLA)"
                    class="form-control"
                    value="{{ stocks[i] }}"
                />-->
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)">
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}" {% if s == stocks[i] %} selected {% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>

                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                    value="{{ weights[i] }}"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            {% endfor %} {% else %}
            <div class="stock-input-group mb-3">
                <label for="stock0" class="form-label visually-hidden"
                    >Stock 1:</label
                >
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            <div class="stock-input-group mb-3">
                <label for="stock1" class="form-label visually-hidden"
                    >Stock 2:</label
                >
                <select name="stock" id="stock1" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input
                    type="number"
                    name="weight"
                    placeholder="Amount (%)"
                    step="0.01"
                    min="0"
                    class="form-control"
                />
                <button type="button" class="btn btn-danger remove-stock-btn">
                    Remove
                </button>
            </div>
            {% endif %}
        </div>
        <div class="d-flex justify-content-start align-items-center gap-3 mt-3">
            <button type="button" id="add-stock-btn" class="btn btn-secondary">
                Add Stock
            </button>
            <label class="ms-2">Train months:
                <input id="train-months" type="number" name="train_months" value="{{ train_months | default(36) }}" min="1" class="form-control d-inline-block" style="width:100px;">
            </label>
            <label class="ms-2">Test months:
                <input id="test-months" type="number" name="test_months" value="{{ test_months | default(3) }}" min="1" class="form-control d-inline-block" style="width:100px;">
            </label>
            <div class="ms-3 align-self-center">
                {% if total_months is defined and total_months %}
                <small class="text-muted">Available months: <strong id="total-months">{{ total_months }}</strong></small>
                {% else %}
                <small class="text-muted">Available months: <strong id="total-months">Unknown</strong></small>
                {% endif %}
            </div>
            <button type="submit" class="btn btn-primary">
                Calculate Frontier
            </button>
        </div>
    </form>

    {% if error %}
    <h4 class="mb-3 text-danger">Error: {{ error }}</h4>
    {% endif %} {% if stats %}
    <h2 class="mb-3 text-primary">Portfolio Stats</h2>

    {%- macro render_stats_table(stats) -%}
        {#
          This macro renders the stats table exactly as you originally designed it.
          'stats' is the dictionary for either the train or test set.
        #}

        <p><strong>Expected/Average Annual Return (%):</strong> {{ stats.return }}</p>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Risk Measure</th>
                    <th>User Portfolio</th>
                    <th>Optimised Portfolio</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Variance</td>
                    <td>{{ stats.user_variance }}</td>
                    <td>
                        {{ stats.opt_variance | default("Could not optimise", true) }}
                    </td>
                </tr>
                <tr>
                    <td>VaR</td>
                    <td>{{ stats.user_var }}</td>
                    <td>
                        {{ stats.opt_var | default("Could not optimise", true) }}
                    </td>
                </tr>
                <tr>
                    <td>CVaR</td>
                    <td>{{ stats.user_cvar }}</td>
                    <td>
                        {{ stats.opt_cvar | default("Could not optimise", true) }}
                    </td>
                </tr>
                <tr>
                    <td>Max Return (same variance)</td>
                    <td>{{ stats.return }}%</td>
                    <td>
                        {% if stats.opt_max_return %}
                            {{ stats.opt_max_return }}%
                        {% else %}
                            Could not optimise
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    {%- endmacro %}


    <ul class="nav nav-tabs" id="statsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="train-tab" data-bs-toggle="tab" data-bs-target="#train-tab-pane" type="button" role="tab" aria-controls="train-tab-pane" aria-selected="true">
                Training Set
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test-tab-pane" type="button" role="tab" aria-controls="test-tab-pane" aria-selected="false">
                Test Set
            </button>
        </li>
    </ul>

    <div class="tab-content" id="statsTabContent">
        <div class="tab-pane fade show active" id="train-tab-pane" role="tabpanel" aria-labelledby="train-tab" tabindex="0">
            <div class="p-3 border border-top-0">
                {{ render_stats_table(stats.train) }}
            </div>
        </div>
        <div class="tab-pane fade" id="test-tab-pane" role="tabpanel" aria-labelledby="test-tab" tabindex="0">
            <div class="p-3 border border-top-0">
                {{ render_stats_table(stats.test) }}
            </div>
        </div>
    </div>

    <h3 class="mt-4">Optimal Portfolios</h3>

    <p>Variance-Optimised Weights</p>
    <pre><code>{{ stats.train.opt_variance_weights }}</code></pre>

    <p>VaR-Optimised Weights</p>
    <pre><code>{{ stats.train.opt_var_weights }}</code></pre>

    <p>CVaR-Optimised Weights</p>
    <pre><code>{{ stats.train.opt_cvar_weights }}</code></pre>

    <h2 class="mb-3 text-primary">Risk Frontiers</h2>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="variance-tab"
                data-bs-toggle="tab"
                data-bs-target="#variance"
                type="button"
                role="tab"
                aria-controls="variance"
                aria-selected="true"
            >
                Variance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="var-tab"
                data-bs-toggle="tab"
                data-bs-target="#var"
                type="button"
                role="tab"
                aria-controls="var"
                aria-selected="false"
            >
                VaR
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="cvar-tab"
                data-bs-toggle="tab"
                data-bs-target="#cvar"
                type="button"
                role="tab"
                aria-controls="cvar"
                aria-selected="false"
            >
                CVaR
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="backtest-tab"
                data-bs-toggle="tab"
                data-bs-target="#backtest"
                type="button"
                role="tab"
                aria-controls="backtest"
                aria-selected="false"
            >
                Backtest
            </button>
        </li>
        <li class="nav-item" role="presentation">
        <button
            class="nav-link"
            id="maxreturn-tab"
            data-bs-toggle="tab"
            data-bs-target="#maxreturn"
            type="button"
            role="tab"
            aria-controls="maxreturn"
            aria-selected="false"
        >
            Max Return
        </button>
    </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div
            class="tab-pane fade show active"
            id="variance"
            role="tabpanel"
            aria-labelledby="variance-tab"
        >
            {% if graph_htmls and graph_htmls[0] %} {{ graph_htmls[0]|safe }} {%
            else %}
            <p>No graph 1 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="var"
            role="tabpanel"
            aria-labelledby="var-tab"
        >
            {% if graph_htmls and graph_htmls[1] %} {{ graph_htmls[1]|safe }} {%
            else %}
            <p>No graph 2 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="cvar"
            role="tabpanel"
            aria-labelledby="cvar-tab"
        >
            {% if graph_htmls and graph_htmls[2] %} {{ graph_htmls[2]|safe }} {%
            else %}
            <p>No graph 3 generated yet.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="backtest"
            role="tabpanel"
            aria-labelledby="backtest-tab"
        >
            {% if used_train is defined and used_test is defined %}
            <p>Using last data: train={{ used_train }} months, test={{ used_test }} months</p>
            {% endif %}
            <div class="backtest-stack">
                <div class="mb-4">
                    <h5>1 Month</h5>
                    {% if backtest_htmls and backtest_htmls[0] %} {{ backtest_htmls[0]|safe }} {% else %}
                    <p>No 1M backtest available.</p>
                    {% endif %}
                </div>
                <div class="mb-4">
                    <h5>2 Months</h5>
                    {% if backtest_htmls and backtest_htmls[1] %} {{ backtest_htmls[1]|safe }} {% else %}
                    <p>No 2M backtest available.</p>
                    {% endif %}
                </div>
                <div class="mb-4">
                    <h5>3 Months</h5>
                    {% if backtest_htmls and backtest_htmls[2] %} {{ backtest_htmls[2]|safe }} {% else %}
                    <p>No 3M backtest available.</p>
                    {% endif %}
                </div>
            </div>
            {% if not backtest_htmls %}
            <p>No backtest available for the selected inputs or insufficient history.</p>
            {% endif %}
        </div>
        <div
            class="tab-pane fade"
            id="maxreturn"
            role="tabpanel"
            aria-labelledby="maxreturn-tab"
        >
            {% if graph_htmls and graph_htmls[3] %} {{ graph_htmls[3]|safe }} {%
            else %}
            <p>No max return graph generated yet.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize stockCount from existing DOM inputs (fallback to 2)
        let stockCount =
            document.querySelectorAll(".stock-input-group").length || 2;

        document
            .getElementById("add-stock-btn")
            .addEventListener("click", function () {
                const stocksContainer =
                    document.getElementById("stocks-container");
                const newStockGroup = document.createElement("div");
                newStockGroup.classList.add("stock-input-group", "mb-3");
                newStockGroup.innerHTML = `
                <label for="stock${stockCount}" class="form-label visually-hidden">Stock ${stockCount + 1}:</label>
                <select name="stock" id="stock${stockCount}" class="form-control">
                    <option value="Stock Symbol (e.g., HDFCBANK)" selected>
                        Select a Stock Symbol
                    </option>
                    {% for s in stock_options %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="weight" placeholder="Amount (%)" step="0.01" min="0" class="form-control">
                <button type="button" class="btn btn-danger remove-stock-btn">Remove</button>
            `;
                stocksContainer.appendChild(newStockGroup);
                stockCount++;
            });

        // Event delegation for remove buttons
        document
            .getElementById("stocks-container")
            .addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-stock-btn")) {
                    // Ensure at least two stock inputs remain
                    if (
                        document.querySelectorAll(".stock-input-group").length >
                        2
                    ) {
                        event.target.closest(".stock-input-group").remove();
                    } else {
                        alert(
                            "You must have at least two stocks in your portfolio.",
                        );
                    }
                }
            });
    });

        // Train/Test auto-clamp logic
        const trainInput = document.getElementById('train-months');
        const testInput = document.getElementById('test-months');
        const totalEl = document.getElementById('total-months');
        const totalMonths = totalEl && totalEl.textContent && !isNaN(parseInt(totalEl.textContent)) ? parseInt(totalEl.textContent) : null;

        function clampValues() {
            if (!totalMonths) return;
            let t = parseInt(trainInput.value) || 0;
            let s = parseInt(testInput.value) || 0;
            if (t < 0) t = 0;
            if (s < 0) s = 0;
            if (t + s > totalMonths) {
                // prefer keeping test as requested, reduce train
                const newTrain = Math.max(totalMonths - s, 0);
                trainInput.value = newTrain;
            }
        }

        trainInput.addEventListener('change', clampValues);
        testInput.addEventListener('change', clampValues);
</script>

{% endblock %}
